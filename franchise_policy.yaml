---
apiVersion: api.cerbos.dev/v1
resourcePolicy:
  version: "default"
  importDerivedRoles:
    - common_roles
  resource: "franchise"
  rules:
    - actions: ["create", "delete"]
      effect: EFFECT_ALLOW
      derivedRoles:
        - admin_user

    - actions: ["view", "list"]
      effect: EFFECT_ALLOW
      derivedRoles:
        - franchise_viewer
        - admin_user

    - actions: ["update"]
      effect: EFFECT_ALLOW
      derivedRoles:
        - admin_user
        - franchise_owner

    - actions: ["view_details", "view_groups"]
      effect: EFFECT_ALLOW
      derivedRoles:
        - franchise_owner
        - admin_user

    # Additional rules for specific franchise operations
    - actions: ["manage_admins"]
      effect: EFFECT_ALLOW
      derivedRoles:
        - admin_user
      condition:
        match:
          expr: request.resource.attr.status != "deleted"

    - actions: ["change_status"]
      effect: EFFECT_ALLOW
      derivedRoles:
        - admin_user
        - franchise_owner
      condition:
        match:
          all:
            of:
              - expr: request.resource.attr.status != "deleted"
              - expr: |-
                  request.principal.attr.role == "super_admin" || 
                  (request.principal.attr.role == "franchise_admin") 